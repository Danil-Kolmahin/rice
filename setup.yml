---
- hosts: "{{ target_hosts }}"
  tasks:
    - name: Set ansible_user variable # TODO: fix https://github.com/ansible/ansible/issues/23530
      set_fact: ansible_user="{{ lookup('pipe', 'whoami') }}"

    - name: Enable sudo for wheel group
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        regexp: '^# %wheel ALL=\(ALL:ALL\) ALL'
        line: "%wheel ALL=(ALL:ALL) ALL"
        state: present
        validate: "visudo -cf %s"
      become: true

    - name: Restricting root login
      ansible.builtin.user:
        name: root
        password: "!"
      become: true

    - name: Set timezone
      community.general.timezone:
        name: Europe/Kyiv
      become: true

    # - name: Set hostname # TODO: move to pre-setup
    #   ansible.builtin.hostname:
    #     name: "{{ hostname }}"

    - name: Copy dotfiles
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: "/home/{{ ansible_user }}/"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        directory_mode: "755"
        mode: "644"
      with_items:
        - .zshrc
        - .zshenv
        - .zprofile
        - .config
        - .local

    - name: Copy .local/bin with exec permissions # fix incorrect "changed" on each run after "Copy dotfiles" task
      ansible.builtin.copy:
        src: ".local/bin"
        dest: "/home/{{ ansible_user }}/.local"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        directory_mode: "755"
        mode: "755"

    - name: Install packages
      ansible.builtin.pacman:
        name:
          # - uv # should be beforehand
          # - git # should be beforehand
          - zsh
          - alacritty
          - sway
          - mako # notifycations
          - swaylock # lock screen for sway
          - wmenu # app launcher
          - ttf-ibm-plex # font, TODO: consider other options - ttf-jetbrains-mono, iosevka-nerd-font
          - noto-fonts-emoji # emojis
          - mc # file manager # TODO: check ranger
          - qutebrowser
          - qt6-base # for qutebrowser TODO: check if actually needed
          - qt6-webengine # for qutebrowser TODO: check if actually needed
          - qt6-wayland # for qutebrowser TODO: check if actually needed
          - xdg-desktop-portal # file access, opening URIs, printing etc | https://github.com/swaywm/sway/wiki/XDG-Desktop-Portal-configuration
          - xdg-desktop-portal-wlr # wayland xdg-desktop-portal
          - xdg-desktop-portal-gtk # backup for xdg-desktop-portal-wlr TODO: check for replacing on kde
          # TODO: test `systemctl --user restart xdg-desktop-portal xdg-desktop-portal-wlr xdg-desktop-portal-gtk` maybe needed for wayland features like screen share in qutebrowser
          - mesa # for qutebrowser TODO: check if actually needed
          - xcb-util-cursor # for qutebrowser TODO: check if actually needed
          # brightnessctl # TODO: test not on WM; check wluma as alternative if ALS
          - flatpak
          - base-devel # for yay tool build
          - ffmpeg # for video/audio processing
          - vlc # media player TODO: search for cli tools
          - pipewire # for audio handling
          - wireplumber # pipewire helper
          - pipewire-pulse # pipewire helper - pulseaudio replacement
          - wl-clipboard # basic copy paste
          - cliphist # wl-clipboard + clipboard history
          - man-db # main man repo
          - man-pages # provides both the Linux and the POSIX.1 man pages
          - tldr # upgraded man
          - openssh # ssh/scp/sftp
          - curl
          - hurl # curl authomation
          - bc # calculator
          - nvm
          - docker
          - docker-compose
          - lazydocker
          - htop
          - tree
          - jq
          - yq
          - k9s
          - github-cli
          - lazygit
          - asciinema # terminal session recording
          - pastel # color palets
          - plantuml # TODO: works but better fix "No X11 DISPLAY variable was set"
          - ncdu # disk usage display
          - fastfetch # system info
          - pass # password manager TODO: configure and test
          # - upower/powertop/auto-cpufreq/tlp # possible eco power/resource management
          - croc # super convinient file node-to-node transfer tool
          - grim # cli screenshots, screenshots gui backend
          - flameshot # screenshots gui
          - gimp # raster image editor
          - inkscape # vector image editor
          - libreoffice-fresh # office suite
          - torbrowser-launcher # the only way to run tor from pacman
          - libnotify # send desktop notifications (notify-send)
          - cava # audio visualization tool
          - speedtest-cli # https://speed.cloudflare.com could be used in browser 
        state: present
      become: true

    - name: Enable and start docker.service
      ansible.builtin.systemd:
        name: docker.service
        enabled: yes
        state: started
      become: true

    - name: Ensure user is in docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes
      become: true

    # relogin !!!

    - name: Set default shell to zsh
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        shell: /usr/bin/zsh
      become: true

    - name: Configure git init.defaultBranch
      community.general.git_config:
        name: init.defaultBranch
        value: main
        scope: global

    - name: Install flatpak packages
      community.general.flatpak:
        name:
          - io.github.ungoogled_software.ungoogled_chromium
          - me.iepure.devtoolbox
          - io.dbeaver.DBeaverCommunity

    - name: Create the `aur_builder` user
      ansible.builtin.user:
        name: aur_builder
        create_home: yes
        group: wheel
      become: yes

    - name: Allow the `aur_builder` user to run `sudo pacman` without a password
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/11-install-aur_builder
        line: "aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman"
        create: yes
        mode: 0644
        validate: "visudo -cf %s"
      become: yes

    - name: Install yay from AUR manually
      ansible.builtin.shell: |
        runuser -u aur_builder -- bash -c '
        git clone https://aur.archlinux.org/yay.git /home/aur_builder/yay || echo "already cloned"
        cd /home/aur_builder/yay
        makepkg -si --noconfirm
        '
      args:
        executable: /bin/bash
        creates: /usr/bin/yay
      become: true

    - name: Install AUR packages manually
      vars:
        aur_packages:
          - chromium-widevine # for qutebrowser, allows streaming (DRM content)
          # - vscodium # TODO: change to vim/neovim/emacs
      ansible.builtin.shell: |
        runuser -u aur_builder -- yay -S --noconfirm --noprogressbar --needed {{ aur_packages | join(' ') }}
      args:
        executable: /bin/bash
      register: aur_install_result
      changed_when: "'Downloading' in aur_install_result.stdout"
      become: true

    - name: Check if qutebrowser is already the default browser
      ansible.builtin.shell: xdg-mime query default x-scheme-handler/http
      register: current_default_browser
      changed_when: false

    - name: Set qutebrowser as default web browser
      ansible.builtin.shell: xdg-settings set default-web-browser org.qutebrowser.qutebrowser.desktop
      when: "'org.qutebrowser.qutebrowser.desktop' not in current_default_browser.stdout"
      changed_when: true

    - name: Set qutebrowser as default for http and https
      ansible.builtin.shell: xdg-mime default org.qutebrowser.qutebrowser.desktop x-scheme-handler/http x-scheme-handler/https
      when: "'org.qutebrowser.qutebrowser.desktop' not in current_default_browser.stdout"
      changed_when: true

    - name: Check if WAYLAND_DISPLAY is in systemd user env
      ansible.builtin.command: systemctl --user show-environment
      register: systemctl_user_env
      changed_when: false

    - name: Export Wayland vars if missing
      ansible.builtin.command: >
        systemctl --user set-environment
        WAYLAND_DISPLAY={{ lookup('env', 'WAYLAND_DISPLAY') }}
        XDG_CURRENT_DESKTOP={{ lookup('env', 'XDG_CURRENT_DESKTOP') | default('sway:wlroots') }}
      when: "'WAYLAND_DISPLAY' not in systemctl_user_env.stdout"

    - name: Download git-activity script
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/aaossa/git-activity/refs/heads/main/git-activity
        dest: "/home/{{ ansible_user }}/.local/bin/git-activity"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "755"
