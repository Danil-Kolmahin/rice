#!/usr/bin/env bash
set -euo pipefail

# TODO: rewrite

load-status() {
    awk '{print $1}' /proc/loadavg
}

disk-status() {
    df -h / | awk 'NR == 2 {print $(NF-1)}'
}

ram-status() {
    awk '/MemTotal/ {mt=$2} /MemAvailable/ {ma=$2} END {printf("%.f%%", 100*(mt-ma)/mt)}' /proc/meminfo
}

volume-status() {
    volume=$(pactl get-sink-volume @DEFAULT_SINK@ | awk '{print $5}')
    mute=$(pactl get-sink-mute @DEFAULT_SINK@ | awk '{print $2}')
    if [ "$mute" = "yes" ]; then
        echo "MUTE"
    else
        echo "$volume"
    fi
}

mic-status() {
    # TODO: fix fn+F9 (probably emulation thing)
    mute=$(pactl get-source-mute @DEFAULT_SOURCE@ | awk '{print $2}')
    if [ "$mute" = "yes" ]; then echo "MUTE"; fi
}

datetime-status() {
    date +'%Y-%m-%d %X'
}

echo '{"version":1}'
echo '['
while true; do
    STATUS=""

    STATUS+="{\"full_text\":\"Kyiv:+15C(cloudy)\"},"
    STATUS+="{\"full_text\":\"BT:on(1)\"},"
    STATUS+="{\"full_text\":\"NET:inet(↓1MB,↑5MB)\"},"
    STATUS+="{\"full_text\":\"LOAD:$(load-status)\"},"
    STATUS+="{\"full_text\":\"DISK:$(disk-status)\"},"
    STATUS+="{\"full_text\":\"RAM:$(ram-status)\"},"
    STATUS+="{\"full_text\":\"CPU:6%(73°C)\"},"
    STATUS+="{\"full_text\":\"RBT!\"},"
    STATUS+="{\"full_text\":\"PWR:80%(7:40h)\"},"
    STATUS+="{\"full_text\":\"BRT:40%\"},"
    STATUS+="{\"full_text\":\"VOL:$(volume-status)\"},"
    # STATUS+="{\"full_text\":\"MIC:$(mic-status)\"},"
    STATUS+="{\"full_text\":\"en\"},"
    STATUS+="{\"full_text\":\"$(datetime-status)\"}"

    echo "[$STATUS],"

    sleep 1
done
