#!/usr/bin/env bash
set -euo pipefail

# TODO: rewrite

reboot-needed-status() {
    vercmp $(pacman -Q linux | cut -d " " -f 2) $(uname -r)
}

net-status() {
    # TODO: check connection
    interface="$(ip route show default | awk '{print $5}')"
    in="$(awk -v i="$interface" '$1 ~ i":" {print $2}' /proc/net/dev)"
    out="$(awk -v i="$interface" '$1 ~ i":" {print $10}' /proc/net/dev)"
}

psi-io-status() {
    awk '/some/ {split($2,arr,"="); printf("%d%%\n",arr[2])}' /proc/pressure/io
}

psi-ram-status() {
    awk '/some/ {split($2,arr,"="); printf("%d%%\n",arr[2])}' /proc/pressure/memory
}

psi-cpu-status() {
    awk '/some/ {split($2,arr,"="); printf("%d%%\n",arr[2])}' /proc/pressure/cpu
}

load-status() {
    awk '{print $1}' /proc/loadavg
}

disk-status() {
    df -h / | awk 'NR == 2 {print $(NF-1)}'
}

ram-status() {
    awk '/MemTotal/ {mt=$2} /MemAvailable/ {ma=$2} END {printf("%.f%%\n", 100*(mt-ma)/mt)}' /proc/meminfo
}

# TODO: refactor, rename, test
workJiffies1=0
totalJiffies1=0
cpu-status() {
    read -r sb_cs_0 sb_cs_user sb_cs_nice sb_cs_system sb_cs_idle sb_cs_iowait sb_cs_irq sb_cs_softirq sb_cs_0 < /proc/stat

    workJiffies2=$((sb_cs_user + sb_cs_nice + sb_cs_system))
    totalJiffies2=$((workJiffies2 + sb_cs_idle + sb_cs_iowait + sb_cs_irq + sb_cs_softirq))

    workDiff=$((workJiffies2 - workJiffies1))
    totalDiff=$((totalJiffies2 - totalJiffies1))

    workJiffies1=$workJiffies2
    totalJiffies1=$totalJiffies2

    echo $((100 * $workDiff / $totalDiff))
}

power-status() {
    local percentage
    local power
    local time_to_empty
    local time_to_full
    percentage=$(upower -b | awk '/percentage/ {print $2}')
    power=$(upower -b | awk '/energy-rate/ {printf "%.1fW\n", $2}')
    case $(upower -b | awk '/state/ {print $2}') in
        discharging)
            time_to_empty=$(upower -b | grep "time to empty" | awk '{print $4 " " $5}')
            echo "$percentage(-$power, $time_to_empty)"
            ;;
        charging)
            time_to_full=$(upower -b | grep "time to full" | awk '{print $4 " " $5}')
            echo "$percentage(+$power, $time_to_full)"
            ;;
        full)
            echo "$percentage"
            ;;
    esac
}

power-profile() {
    case $(tlpctl get) in
        performance) echo "AC" ;;
        balanced) echo "BAT" ;;
        power-saver) echo "SAV" ;;
    esac
}

brightness-level() {
    brightnessctl i -m | awk -F',' '{print $4}' | sed 's/.$//'
}

volume-status() {
    volume=$(pactl get-sink-volume @DEFAULT_SINK@ | awk '{print $5}')
    mute=$(pactl get-sink-mute @DEFAULT_SINK@ | awk '{print $2}')
    if [ "$mute" = "yes" ]; then
        echo "MUTE"
    else
        echo "$volume"
    fi
}

mic-status() {
    # TODO: fix fn+F9 (probably emulation thing)
    mute=$(pactl get-source-mute @DEFAULT_SOURCE@ | awk '{print $2}')
    if [ "$mute" = "yes" ]; then echo "MUTE"; fi
}

keyboard-layout() {
    # TODO improve to take original lang name, use xkb
    swaymsg -t get_inputs | jq 'map(select(has("xkb_active_layout_name")))[0].xkb_active_layout_name' | sed 's/.*/\L&/' | cut -c2-3
}

datetime-status() {
    date +'%Y-%m-%d %X'
}

echo '{"version":1}'
echo '['

interface="$(ip route show default | awk '{print $5}')"
in="$(awk -v i="$interface" '$1 ~ i":" {print $2}' /proc/net/dev)"
out="$(awk -v i="$interface" '$1 ~ i":" {print $10}' /proc/net/dev)"

while true; do
    STATUS=""

    [[ $(reboot-needed-status) -gt 0 ]] && STATUS+="{\"full_text\":\"REBOOT REQUIRED\",\"color\":\"#000000\",\"background\":\"#ff0000\",\"border\":\"#00000000\"},"
    # STATUS+="{\"full_text\":\"BT:on(1)\"},"
    
    interface="$(ip route show default | awk '{print $5}')"
    new_in="$(awk -v i="$interface" '$1 ~ i":" {print $2}' /proc/net/dev)"
    new_out="$(awk -v i="$interface" '$1 ~ i":" {print $10}' /proc/net/dev)"

    STATUS+="{\"full_text\":\"NET:↓$(echo "$new_in - $in" | bc | numfmt --to=iec)B,↑$(echo "$new_out - $out" | bc | numfmt --to=iec)B\"},"

    in="$new_in"
    out="$new_out"

    STATUS+="{\"full_text\":\"PSI:io$(psi-io-status),ram$(psi-ram-status),cpu$(psi-cpu-status)\"},"
    STATUS+="{\"full_text\":\"DISK:$(disk-status)\"},"
    STATUS+="{\"full_text\":\"RAM:$(ram-status)\"},"
    STATUS+="{\"full_text\":\"CPU:$(cpu-status)%\"}," # TODO: add ,73°C
    if [ $(upower -b | awk '/state/ {print $2}') = "discharging" ]; then
        STATUS+="{\"full_text\":\"$(power-profile):$(power-status)\",\"color\":\"#000000\",\"background\":\"#ff0000\",\"border\":\"#00000000\"},"
    else
        STATUS+="{\"full_text\":\"$(power-profile):$(power-status)\"},"
    fi
    STATUS+="{\"full_text\":\"BRT:$(brightness-level)%\"},"
    STATUS+="{\"full_text\":\"VOL:$(volume-status)\"},"
    # STATUS+="{\"full_text\":\"MIC:$(mic-status)\"},"
    STATUS+="{\"full_text\":\"$(keyboard-layout)\"},"
    STATUS+="{\"full_text\":\"$(datetime-status)\"}"

    echo "[$STATUS],"

    sleep 1
done
